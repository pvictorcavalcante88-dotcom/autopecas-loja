<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto | AutoPeças Veloz</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <i class="ph ph-car-profile"></i> AutoPeças <span>Veloz</span>
            </a>
            <div class="header-actions">
                <a href="cart.html" class="action-button cart-button">
                    <i class="ph ph-shopping-cart"></i><span>Carrinho</span>
                </a>
            </div>
        </div>
    </header>

    <main class="product-detail-container" id="product-container">
        <div class="detail-image">
            <img id="prod-img" src="" alt="Imagem do Produto" onerror="this.src='https://placehold.co/400'">
        </div>

        <div class="detail-info">
            <span class="detail-code" id="prod-cat">Categoria</span>
            <h1 id="prod-title">Carregando produto...</h1>
            
            <div class="detail-price-box">
                <div class="detail-old-price" id="prod-old-price"></div>
                <div class="detail-price" id="prod-price">R$ ...</div>
                <div class="detail-installments">em até 12x no cartão</div>
            </div>

            <div id="affiliate-area" class="affiliate-profit-box">
                <h4 style="margin-bottom:10px; color:#2c3e50;"><i class="ph ph-currency-circle-dollar"></i> Painel do Parceiro</h4>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <label>Sua Margem:</label>
                    <input type="number" id="input-margem" value="0" style="width:60px; padding:5px; border-radius:4px; border:1px solid #ccc;"> %
                </div>
                <div style="font-size:0.9rem; color:#27ae60; font-weight:bold;">
                    Seu Lucro nesta venda: <span id="lucro-estimado">R$ 0,00</span>
                </div>
            </div>

            <p id="prod-desc" style="color:#666; line-height:1.6; margin-bottom:20px;">...</p>

            <div class="action-group">
                <div class="qty-selector">
                    <button onclick="mudarQtd(-1)">-</button>
                    <input type="text" id="qtd" value="1" readonly>
                    <button onclick="mudarQtd(1)">+</button>
                </div>
                <button onclick="adicionarAoCarrinhoAtual()" class="btn-buy-now">
                    <i class="ph ph-shopping-cart-plus"></i> Adicionar ao Carrinho
                </button>
            </div>

            <div class="security-badges">
                <div class="badge-item"><i class="ph ph-shield-check"></i> Compra Segura</div>
                <div class="badge-item"><i class="ph ph-truck"></i> Entrega Rápida</div>
                <div class="badge-item"><i class="ph ph-thumbs-up"></i> Garantia Veloz</div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <p>© 2025 AutoPeças Veloz.</p>
    </footer>

    <script src="script.js"></script>
    <script>
        // Lógica específica desta página
        let PRODUTO_ATUAL = null;
        let MARGEM_ATUAL = 0;

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if(id) carregarProduto(id);
            
            // Atualiza valores se digitar a quantidade manualmente
            document.getElementById('qtd').addEventListener('input', atualizarPrecoTela);
        });

        async function carregarProduto(id) {
            try {
                // Tenta pegar margem do afiliado (se logado)
                const afData = localStorage.getItem('afiliadoLogado');
                const isAfiliado = !!afData;
                
                // Se for afiliado, pega a margem salva ou usa 0
                if(isAfiliado) {
                    MARGEM_ATUAL = parseFloat(localStorage.getItem('minhaMargem') || 0);
                    document.getElementById('affiliate-area').style.display = 'block';
                    document.getElementById('input-margem').value = MARGEM_ATUAL;
                }

                // Busca dados no servidor
                const res = await fetch(`${API_URL}/products/${id}`);
                if(!res.ok) throw new Error("Produto não encontrado");
                
                PRODUTO_ATUAL = await res.json();

                // Preenche a tela
                document.getElementById('prod-img').src = PRODUTO_ATUAL.image || PRODUTO_ATUAL.imagem;
                document.getElementById('prod-title').textContent = PRODUTO_ATUAL.name || PRODUTO_ATUAL.titulo;
                document.getElementById('prod-cat').textContent = (PRODUTO_ATUAL.categoria || "Peças") + " > Cód: " + PRODUTO_ATUAL.id;
                document.getElementById('prod-desc').textContent = PRODUTO_ATUAL.descricao || "Produto de alta qualidade original da AutoPeças Veloz.";

                atualizarPrecoTela();

            } catch(e) {
                document.getElementById('product-container').innerHTML = '<h2>Produto não encontrado.</h2>';
            }
        }

        // Atualiza preço quando muda a margem
        document.getElementById('input-margem').addEventListener('input', (e) => {
            MARGEM_ATUAL = parseFloat(e.target.value) || 0;
            atualizarPrecoTela();
        });

        function atualizarPrecoTela() {
            if(!PRODUTO_ATUAL) return;

            // 1. Pega os valores básicos
            const precoBase = parseFloat(PRODUTO_ATUAL.price || PRODUTO_ATUAL.preco_novo);
            const qtd = parseInt(document.getElementById('qtd').value) || 1; // Pega a quantidade atual

            // 2. Calcula preço unitário com margem
            const precoUnitarioFinal = precoBase * (1 + (MARGEM_ATUAL / 100));
            
            // 3. Calcula Totais
            const lucroUnitario = precoUnitarioFinal - precoBase;
            const lucroTotal = lucroUnitario * qtd; // Multiplica o lucro pela quantidade

            // 4. Exibe na tela
            // Preço do Produto (Mantém unitário para padrão de loja, ou multiplica se preferir)
            document.getElementById('prod-price').textContent = precoUnitarioFinal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            
            // Lucro (Agora mostra o TOTAL baseado na quantidade)
            document.getElementById('lucro-estimado').innerHTML = `
                ${lucroTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} 
                <small style="color:#7f8c8d; font-weight:normal;">(${qtd}x itens)</small>
            `;
            
            // Preço antigo (efeito visual)
            if(MARGEM_ATUAL < 10) {
                document.getElementById('prod-old-price').textContent = (precoUnitarioFinal * 1.2).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            } else {
                document.getElementById('prod-old-price').textContent = "";
            }
        }

        function mudarQtd(delta) {
            const input = document.getElementById('qtd');
            let val = parseInt(input.value) + delta;
            if(val < 1) val = 1;
            input.value = val;
            
            // IMPORTANTE: Chama a atualização aqui também!
            atualizarPrecoTela();
        }

        function adicionarAoCarrinhoAtual() {
            if(!PRODUTO_ATUAL) return;
            const qtd = parseInt(document.getElementById('qtd').value);
            
            let carrinho = JSON.parse(localStorage.getItem('nossoCarrinho') || '[]');
            const index = carrinho.findIndex(i => i.id == PRODUTO_ATUAL.id);
            
            if (index > -1) {
                carrinho[index].quantidade += qtd;
                carrinho[index].customMargin = MARGEM_ATUAL; 
            } else {
                carrinho.push({ 
                    id: PRODUTO_ATUAL.id, 
                    quantidade: qtd,
                    customMargin: MARGEM_ATUAL 
                });
            }
            
            localStorage.setItem('nossoCarrinho', JSON.stringify(carrinho));
            atualizarIconeCarrinho(); 
            
            // Feedback visual melhor
            const btn = document.querySelector('.btn-buy-now');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-check"></i> Adicionado!';
            btn.style.background = '#27ae60';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = ''; // Volta ao gradiente original
            }, 2000);
        }
    </script>
</body>
</html>