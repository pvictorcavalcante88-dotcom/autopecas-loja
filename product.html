<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto | AutoPeças Veloz</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Barra de Pesquisa */
        .search-container { flex: 1; max-width: 500px; margin: 0 20px; display: flex; align-items: center; background: #f1f2f6; border-radius: 8px; padding: 5px 15px; }
        .search-container input { flex: 1; border: none; background: transparent; padding: 10px; outline: none; font-size: 1rem; }
        .search-container button { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #2c3e50; }
        .search-container button:hover { color: #e67e22; }

        @media (max-width: 768px) {
            .header-container { flex-wrap: wrap; gap: 10px; }
            .search-container { order: 3; max-width: 100%; margin: 0; }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <i class="ph ph-car-profile"></i> AutoPeças <span>Veloz</span>
            </a>

            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar peça (ex: Motor, Freio)...">
                <button id="search-button"><i class="ph ph-magnifying-glass"></i></button>
            </div>

            <div class="header-actions">
                <a href="cart.html" class="action-button cart-button">
                    <i class="ph ph-shopping-cart"></i><span>Carrinho</span>
                </a>
            </div>
        </div>
    </header>

    <main class="product-detail-container" id="product-container">
        <div class="detail-image">
            <img id="prod-img" src="" alt="Imagem do Produto" onerror="this.src='https://placehold.co/400'">
        </div>

        <div class="detail-info">
            <span class="detail-code" id="prod-cat">Categoria</span>
            <h1 id="prod-title">Carregando produto...</h1>
            
            <div class="detail-price-box">
                <div class="detail-old-price" id="prod-old-price"></div>
                <div class="detail-price" id="prod-price">R$ ...</div>
                <div class="detail-installments">em até 12x no cartão</div>
            </div>

            <div id="affiliate-area" class="affiliate-profit-box" style="display:none;">
                <h4 style="margin-bottom:10px; color:#2c3e50;"><i class="ph ph-currency-circle-dollar"></i> Painel do Parceiro</h4>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <label>Sua Margem:</label>
                    <input type="number" id="input-margem" value="0" style="width:60px; padding:5px; border-radius:4px; border:1px solid #ccc;"> %
                </div>
                <div style="font-size:0.9rem; color:#27ae60; font-weight:bold;">
                    Seu Lucro Total: <span id="lucro-estimado">R$ 0,00</span>
                </div>
            </div>

            <p id="prod-desc" style="color:#666; line-height:1.6; margin-bottom:20px;">...</p>

            <div class="action-group">
                <div class="qty-selector">
                    <button onclick="mudarQtd(-1)">-</button>
                    <input type="text" id="qtd" value="1" readonly>
                    <button onclick="mudarQtd(1)">+</button>
                </div>
                <button onclick="adicionarAoCarrinhoAtual()" class="btn-buy-now">
                    <i class="ph ph-shopping-cart-plus"></i> Adicionar ao Carrinho
                </button>
            </div>
            
            <div id="box-sugestao" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
                    <i class="ph ph-lightbulb" style="color:#f1c40f; font-size:1.2rem;"></i> 
                    Conhece essa peça por outro nome? Ajude a melhorar a busca!
                </p>
                <button onclick="abrirModalSugestao()" style="background:#fff; border:1px solid #3498db; color:#3498db; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">
                    + Adicionar Conhecimento
                </button>
            </div>

            <div class="security-badges">
                <div class="badge-item"><i class="ph ph-shield-check"></i> Compra Segura</div>
                <div class="badge-item"><i class="ph ph-truck"></i> Entrega Rápida</div>
                <div class="badge-item"><i class="ph ph-thumbs-up"></i> Garantia Veloz</div>
            </div>
        </div>
    </main>

    <div id="modal-sugestao" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:white; padding:25px; width:400px; border-radius:8px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
            <h3>Sugerir Informação</h3>
            <p style="font-size:0.85rem; color:#666;">O que você quer adicionar? (Ex: "Serve no Gol G5", "Conhecido como Tripoide")</p>
            
            <input type="text" id="termo-sugestao" placeholder="Digite o termo..." style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:4px;">
            
            <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
                <button onclick="document.getElementById('modal-sugestao').style.display='none'" style="padding:8px 15px; border:none; background:#eee; cursor:pointer; border-radius:4px;">Cancelar</button>
                <button onclick="enviarSugestao()" style="padding:8px 15px; border:none; background:#27ae60; color:white; font-weight:bold; cursor:pointer; border-radius:4px;">Enviar</button>
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <p>© 2025 AutoPeças Veloz.</p>
    </footer>

    <script src="script.js"></script>
    <script>
        const API_URL = ''; // Garante que a variável existe
        let PRODUTO_ATUAL = null;
        let MARGEM_ATUAL = 0;

        // --- 1. BUSCA ---
        const btnSearch = document.getElementById('search-button');
        const inputSearch = document.getElementById('search-input');

        function realizarBusca() {
            const termo = inputSearch.value.trim();
            if(termo) window.location.href = `index.html?search=${encodeURIComponent(termo)}`;
        }
        btnSearch.addEventListener('click', realizarBusca);
        inputSearch.addEventListener('keypress', (e) => { if(e.key === 'Enter') realizarBusca(); });

        // --- 2. CARREGAMENTO ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if(id) carregarProduto(id);
            
            document.getElementById('qtd').addEventListener('input', atualizarPrecoTela);
            document.getElementById('input-margem').addEventListener('input', (e) => {
                MARGEM_ATUAL = parseFloat(e.target.value) || 0;
                atualizarPrecoTela();
            });
        });

        async function carregarProduto(id) {
            try {
                // Afiliado Logado?
                const afData = localStorage.getItem('afiliadoLogado');
                const isAfiliado = !!afData;
                
                if(isAfiliado) {
                    MARGEM_ATUAL = parseFloat(localStorage.getItem('minhaMargem') || 0);
                    document.getElementById('affiliate-area').style.display = 'block';
                    document.getElementById('input-margem').value = MARGEM_ATUAL;
                    
                    // Agora este elemento EXISTE no HTML, então não vai dar erro
                    document.getElementById('box-sugestao').style.display = 'block'; 
                }

                const res = await fetch(`${API_URL}/products/${id}`);
                if(!res.ok) throw new Error("Produto não encontrado");
                
                PRODUTO_ATUAL = await res.json();

                document.getElementById('prod-img').src = PRODUTO_ATUAL.image || PRODUTO_ATUAL.imagem;
                document.getElementById('prod-title').textContent = PRODUTO_ATUAL.name || PRODUTO_ATUAL.titulo;
                document.getElementById('prod-cat').textContent = (PRODUTO_ATUAL.categoria || "Peças") + " > Cód: " + PRODUTO_ATUAL.id;
                document.getElementById('prod-desc').textContent = PRODUTO_ATUAL.descricao || "Peça original com garantia.";

                atualizarPrecoTela();

            } catch(e) {
                console.error(e);
                document.getElementById('product-container').innerHTML = '<h2>Produto não encontrado.</h2>';
            }
        }

        // --- 3. LÓGICA DE PREÇO ---
        function atualizarPrecoTela() {
            if(!PRODUTO_ATUAL) return;

            const precoBase = parseFloat(PRODUTO_ATUAL.price || PRODUTO_ATUAL.preco_novo);
            const qtd = parseInt(document.getElementById('qtd').value) || 1;

            const precoUnitarioFinal = precoBase * (1 + (MARGEM_ATUAL / 100));
            const lucroUnitario = precoUnitarioFinal - precoBase;
            const lucroTotal = lucroUnitario * qtd; 

            document.getElementById('prod-price').textContent = precoUnitarioFinal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('lucro-estimado').innerHTML = `${lucroTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} <small style="color:#7f8c8d;">(${qtd} itens)</small>`;
            
            if(MARGEM_ATUAL < 10) {
                document.getElementById('prod-old-price').textContent = (precoUnitarioFinal * 1.2).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            } else {
                document.getElementById('prod-old-price').textContent = "";
            }
        }

        function mudarQtd(delta) {
            const input = document.getElementById('qtd');
            let val = parseInt(input.value) + delta;
            if(val < 1) val = 1;
            input.value = val;
            atualizarPrecoTela();
        }

        function adicionarAoCarrinhoAtual() {
            if(!PRODUTO_ATUAL) return;
            const qtd = parseInt(document.getElementById('qtd').value);
            
            let carrinho = JSON.parse(localStorage.getItem('nossoCarrinho') || '[]');
            const index = carrinho.findIndex(i => i.id == PRODUTO_ATUAL.id);
            
            if (index > -1) {
                carrinho[index].quantidade += qtd;
                carrinho[index].customMargin = MARGEM_ATUAL; 
            } else {
                carrinho.push({ id: PRODUTO_ATUAL.id, quantidade: qtd, customMargin: MARGEM_ATUAL });
            }
            
            localStorage.setItem('nossoCarrinho', JSON.stringify(carrinho));
            atualizarIconeCarrinho(); // Função global do script.js
            
            const btn = document.querySelector('.btn-buy-now');
            btn.innerHTML = '<i class="ph ph-check"></i> Adicionado!';
            btn.style.background = '#27ae60';
            setTimeout(() => {
                btn.innerHTML = '<i class="ph ph-shopping-cart-plus"></i> Adicionar ao Carrinho';
                btn.style.background = ''; 
            }, 2000);
        }

        // --- 4. SUGESTÕES (Agora fora da função principal) ---
        function abrirModalSugestao() {
            document.getElementById('modal-sugestao').style.display = 'flex';
        }

        async function enviarSugestao() {
            const termo = document.getElementById('termo-sugestao').value;
            if(!termo) return alert("Digite algo!");
            
            const afData = localStorage.getItem('afiliadoLogado');
            if (!afData) return alert("Você precisa estar logado.");
            
            const token = JSON.parse(afData).token;

            try {
                const res = await fetch(`${API_URL}/afiliado/sugestoes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ produtoId: PRODUTO_ATUAL.id, termo: termo, motivo: "Sugestão via vitrine" })
                });
                if(res.ok) {
                    alert("Obrigado! Sua sugestão foi enviada para análise.");
                    document.getElementById('modal-sugestao').style.display = 'none';
                    document.getElementById('termo-sugestao').value = '';
                } else {
                    alert("Erro ao enviar sugestão.");
                }
            } catch(e) { alert("Erro de conexão."); }
        }
    </script>
</body>
</html>