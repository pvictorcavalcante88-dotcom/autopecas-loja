<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliados - Admin</title>
    <link rel="stylesheet" href="admin.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* =========================================
           ESTILOS (Igual ao Dashboard)
           ========================================= */
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f6f8; --blue: #005fb9; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; }
        
        .admin-container { display: flex; width: 100%; min-height: 100vh; }

        /* MENU */
        aside.sidebar { width: 250px; background: var(--primary); color: white; min-height: 100vh; position: fixed; top: 0; left: 0; z-index: 1000; display: flex; flex-direction: column; }
        aside h3 { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin: 0; }
        aside nav a { display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: #bdc3c7; text-decoration: none; transition: 0.3s; cursor: pointer; }
        aside nav a:hover, aside nav a.active { background: rgba(255,255,255,0.1); color: var(--accent); border-left: 4px solid var(--accent); }

        /* CONTEÚDO */
        main.main-content { margin-left: 250px; padding: 30px; width: 100%; flex: 1; }
        header h1 { margin: 0; color: var(--primary); }

        /* CARDS */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; margin-top: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { margin: 0 0 10px; font-size: 0.9rem; color: #666; }
        .stat-card .val { font-size: 1.5rem; font-weight: bold; color: var(--blue); }

        /* TABELA */
        .card-table { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; white-space: nowrap; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #555; }

        /* MOBILE */
        @media (max-width: 768px) {
            .admin-container { flex-direction: column; }
            aside.sidebar { width: 100%; height: auto; position: relative; padding-bottom: 10px; }
            aside nav { display: flex; overflow-x: auto; padding: 0 10px; gap: 10px; }
            aside nav::-webkit-scrollbar { display: none; }
            aside nav a { flex: 0 0 auto; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 8px 15px; border-left: none !important; }
            main.main-content { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <h3>Admin AutoPeças</h3>
            <nav>
                <a href="admin_dashboard.html"><i class="ph ph-gauge"></i> Dashboard</a>
                <a href="admin_produtos.html"><i class="ph ph-package"></i> Produtos</a>
                <a href="admin_pedidos.html"><i class="ph ph-shopping-cart-simple"></i> Pedidos</a>
                <a href="admin_afiliados.html" class="active"><i class="ph ph-users"></i> Afiliados & Financeiro</a>
                <a href="admin_sugestoes.html"><i class="ph ph-lightbulb"></i> Sugestões</a>
                <a href="#" id="logout-button" style="color:#e74c3c;"><i class="ph ph-sign-out"></i> Sair</a>
            </nav>
        </aside>

        <main class="main-content">
            <header>
                <h1>Gestão de Afiliados</h1>
            </header>

            <div class="stats-row">
                <div class="stat-card">
                    <h3>Total Afiliados</h3>
                    <div class="val" id="total-afiliados">0</div>
                </div>
                <div class="stat-card">
                    <h3>Comissões Pendentes</h3>
                    <div class="val" style="color: orange;" id="total-pendente">R$ 0,00</div>
                </div>
            </div>

            <div class="card-table">
                <h3>Lista de Parceiros</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Código</th>
                                <th>Vendas Aprovadas</th>
                                <th>Comissão</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-afiliados">
                            <tr><td colspan="5" align="center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="admin.js"></script>

    <script>
        // Função que o admin.js pode chamar ou roda sozinha
        function carregarAfiliados() {
            const afiliados = JSON.parse(localStorage.getItem('db_afiliados') || '[]');
            const vendas = JSON.parse(localStorage.getItem('db_vendas') || '[]');

            let totalComissaoGeral = 0;
            const tbody = document.getElementById('lista-afiliados');
            tbody.innerHTML = '';

            if(afiliados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" align="center">Nenhum afiliado cadastrado.</td></tr>';
                document.getElementById('total-afiliados').innerText = '0';
                return;
            }

            afiliados.forEach(af => {
                // Filtra vendas Aprovadas ou Entregues deste afiliado
                const vendasDoAfiliado = vendas.filter(v => 
                    (v.afiliadoCodigo === af.codigo || (v.afiliado && v.afiliado.codigo === af.codigo)) && 
                    (v.status === 'APROVADO' || v.status === 'ENTREGUE')
                );

                const qtdVendas = vendasDoAfiliado.length;
                const comissaoTotal = vendasDoAfiliado.reduce((acc, curr) => acc + parseFloat(curr.comissaoGerada || 0), 0);
                
                totalComissaoGeral += comissaoTotal;

                // Status (Aprovado ou Pendente)
                const statusHtml = af.aprovado 
                    ? '<span style="color:green; background:#d4edda; padding:2px 6px; border-radius:4px; font-size:0.8rem;">Ativo</span>' 
                    : '<span style="color:#856404; background:#fff3cd; padding:2px 6px; border-radius:4px; font-size:0.8rem;">Pendente</span>';

                // Botão de Ação
                let btn = '';
                if(!af.aprovado) {
                    btn = `<button onclick="toggleStatusAfiliado(${af.id}, true)" style="cursor:pointer; background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:4px;">Aprovar</button>`;
                } else {
                    btn = `<button onclick="toggleStatusAfiliado(${af.id}, false)" style="cursor:pointer; background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:4px;">Bloquear</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <strong>${af.nome}</strong><br>
                            <small style="color:#666">${af.email}</small>
                        </td>
                        <td><span style="background:#eee; padding:2px 5px; border-radius:4px;">${af.codigo}</span></td>
                        <td>${qtdVendas}</td>
                        <td style="color:#27ae60; font-weight:bold;">${comissaoTotal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                        <td>
                            ${statusHtml} ${btn}
                        </td>
                    </tr>
                `;
            });

            document.getElementById('total-afiliados').innerText = afiliados.length;
            document.getElementById('total-pendente').innerText = totalComissaoGeral.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        }

        // Função para Aprovar/Bloquear
        function toggleStatusAfiliado(id, novoStatus) {
            const afiliados = JSON.parse(localStorage.getItem('db_afiliados') || '[]');
            const index = afiliados.findIndex(a => a.id === id);
            
            if (index !== -1) {
                afiliados[index].aprovado = novoStatus;
                localStorage.setItem('db_afiliados', JSON.stringify(afiliados));
                carregarAfiliados(); // Recarrega a tabela
            }
        }

        // Se o admin.js não chamar automaticamente, chamamos aqui
        document.addEventListener("DOMContentLoaded", carregarAfiliados);
    </script>
</body>
</html>