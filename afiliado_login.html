<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliados - AutoPe√ßas Veloz</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        
        .login-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; position: relative; }
        
        .logo { color: #2c3e50; font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; display: block; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logo i { color: #e67e22; font-size: 2rem; }

        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; cursor: pointer; color: #777; font-weight: bold; transition: 0.3s; }
        .tab.active { color: #e67e22; border-bottom: 3px solid #e67e22; }
        
        form { display: none; flex-direction: column; gap: 15px; }
        form.active { display: flex; }
        
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: #e67e22; }
        
        button { padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.3s; }
        button:hover { background: #34495e; }
        
        .note { font-size: 0.8rem; color: #666; text-align: left; margin-top: -10px; }

        /* LINK ESQUICI MINHA SENHA */
        .forgot-link {
            display: block;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #e67e22;
            text-decoration: none;
            cursor: pointer;
        }
        .forgot-link:hover { text-decoration: underline; }

        /* MODAL DE RECUPERA√á√ÉO */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; width: 90%; max-width: 350px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .modal-box h3 { margin-top: 0; color: #2c3e50; }
        .btn-zap { background: #27ae60; margin-top: 10px; width: 100%; }
        .btn-close { background: #ccc; color: #333; margin-top: 5px; width: 100%; }
    </style>
</head>
<body>

    <div class="login-container">
        <a href="index.html" class="logo"><i class="ph ph-handshake"></i> Afiliados Veloz</a>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('login')">Entrar</div>
            <div class="tab" onclick="switchTab('register')">Criar Conta</div>
        </div>

        <form id="login-form" class="active">
            <input type="tel" id="login-telefone" placeholder="Seu Celular (apenas n√∫meros)" required>
            <input type="password" id="login-senha" placeholder="Sua Senha" required>
            <button type="button" onclick="fazerLogin()">Acessar Painel</button>
            
            <a onclick="abrirModalRecuperar()" class="forgot-link">Esqueci minha senha</a>
        </form>

        <form id="register-form">
            <input type="text" id="reg-nome" placeholder="Seu Nome Completo" required>
            <input type="tel" id="reg-telefone" placeholder="Seu Celular (WhatsApp)" required>
            <input type="text" id="reg-codigo" placeholder="Crie seu C√≥digo (Ex: joao10)" required>
            <p class="note">Este ser√° seu link: site.com/?ref=<b>joao10</b></p>
            <input type="text" id="reg-pix" placeholder="Sua Chave PIX (para receber)">
            <input type="password" id="reg-senha" placeholder="Crie uma Senha" required>
            <button type="button" onclick="fazerCadastro()">Cadastrar e Come√ßar</button>
        </form>
    </div>

    <div id="modal-recuperar" class="modal-overlay">
        <div class="modal-box">
            <h3>Recuperar Senha üîê</h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                Para sua seguran√ßa, a recupera√ß√£o √© feita via Suporte. Digite seu telefone abaixo:
            </p>
            <input type="tel" id="recuperar-telefone" placeholder="Seu telefone cadastrado" style="width: 100%; box-sizing: border-box;">
            
            <button onclick="enviarRecuperacao()" class="btn-zap">
                <i class="ph ph-whatsapp-logo"></i> Chamar no Suporte
            </button>
            <button onclick="fecharModal()" class="btn-close">Cancelar</button>
        </div>
    </div>

    <script>
        const API_URL = ''; // Se estiver local, deixe vazio.

        // --- L√ìGICA DAS ABAS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('form').forEach(f => f.classList.remove('active'));
            
            if(tab === 'login') {
                document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }
        }

        // --- L√ìGICA DO MODAL ---
        function abrirModalRecuperar() {
            // Tenta pegar o telefone que o usu√°rio j√° digitou no login
            const telDigitado = document.getElementById('login-telefone').value;
            if(telDigitado) document.getElementById('recuperar-telefone').value = telDigitado;
            
            document.getElementById('modal-recuperar').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modal-recuperar').style.display = 'none';
        }

        function enviarRecuperacao() {
            const telefone = document.getElementById('recuperar-telefone').value;
            if(!telefone) return alert("Digite seu telefone.");

            // SEU N√öMERO DE SUPORTE AQUI (ADMIN)
            const numeroAdmin = "558287515891"; // <--- Coloque seu n√∫mero aqui

            const msg = `Ol√° Suporte! Sou afiliado (Tel: ${telefone}) e esqueci minha senha. Poderia redefinir?`;
            
            // Abre o WhatsApp
            window.open(`https://wa.me/${numeroAdmin}?text=${encodeURIComponent(msg)}`, '_blank');
            fecharModal();
        }

        // --- L√ìGICA DE LOGIN E CADASTRO (Chamando o Backend) ---
        
        async function fazerLogin() {
            const telefone = document.getElementById('login-telefone').value;
            const senha = document.getElementById('login-senha').value;
            const btn = document.querySelector('#login-form button');

            if(!telefone || !senha) return alert("Preencha todos os campos.");

            btn.innerText = "Entrando..."; btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/afiliado/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telefone, senha })
                });

                const data = await res.json();

                if(res.ok) {
                    // Salva token e dados
                    localStorage.setItem('afiliadoToken', data.token);
                    // Opcional: Salvar objeto completo para compatibilidade
                    localStorage.setItem('afiliadoLogado', JSON.stringify(data));
                    
                    window.location.href = 'afiliado_dashboard.html';
                } else {
                    alert(data.erro || "Erro ao entrar.");
                }
            } catch(e) {
                alert("Erro de conex√£o.");
            } finally {
                btn.innerText = "Acessar Painel"; btn.disabled = false;
            }
        }

        async function fazerCadastro() {
            const dados = {
                nome: document.getElementById('reg-nome').value,
                telefone: document.getElementById('reg-telefone').value,
                codigo: document.getElementById('reg-codigo').value,
                chavePix: document.getElementById('reg-pix').value,
                senha: document.getElementById('reg-senha').value
            };

            if(!dados.nome || !dados.telefone || !dados.codigo || !dados.senha) return alert("Preencha os campos obrigat√≥rios.");

            const btn = document.querySelector('#register-form button');
            btn.innerText = "Criando..."; btn.disabled = true;

            try {
                // Precisamos criar essa rota /afiliado/cadastro no server.js se ainda n√£o existir
                // Se voc√™ ainda n√£o tem, me avise que criamos!
                // Vou assumir que vamos criar ou adaptar.
                
                // DICA: Voc√™ pode adaptar para enviar direto pro Zap se preferir aprova√ß√£o manual
                // Mas o ideal √© salvar no banco como "aprovado: false"
                
                const res = await fetch(`${API_URL}/afiliado/cadastro`, { // Precisamos criar essa rota
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                if(res.ok) {
                    alert("Cadastro realizado! Aguarde a aprova√ß√£o do administrador.");
                    switchTab('login');
                } else {
                    const err = await res.json();
                    alert("Erro: " + (err.erro || "Falha no cadastro"));
                }
            } catch(e) {
                alert("Erro de conex√£o. Tente mais tarde.");
            } finally {
                btn.innerText = "Cadastrar e Come√ßar"; btn.disabled = false;
            }
        }

    </script>
</body>
</html>