generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Mude de "sqlite" para "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id    Int     @id @default(autoincrement())
  email String  @unique
  senha String
}

// MODELO AFILIADO (Login por Telefone)
model Afiliado {
  id        Int      @id @default(autoincrement())
  nome      String
  telefone  String   @unique
  senha     String
  codigo    String   @unique
  chavePix  String?
  saldo     Float    @default(0.0)
  aprovado  Boolean  @default(false)
  
  // NOVO: A margem de lucro dele (em %)
  margem    Float    @default(0.0) 

  banco     String?  // Ex: Nubank
  agencia   String?
  conta     String?
  cpf     String?
  endereco     String?
  foto     String?

  
  pedidos   Pedido[] 
  orcamentos Orcamento[]
  mensagens Mensagem[]
  sugestoes   Sugestao[]
  saques      Saque[]
  clientes    ClienteAfiliado[]

  createdAt DateTime @default(now())
}

model Produto {
  id                  Int      @id @default(autoincrement())
  titulo              String
  pesquisa            String?
  preco_custo           Float    @default(0.0)
  preco_novo          Float
  preco_antigo        Float?
  desconto            String?
  estoque             Int      @default(0)
  categoria           String?
  referencia          String?
  fabricante          String?
  imagem_fabricante   String?
  carros              String?
  ano                 String?
  motor               String?
  quatidade_por_veiculo Int?
  imagem              String?
  imagens_extra       String?
  produtos_relacionados String?
  tags        String?
  sugestoes   Sugestao[]

  tinyId          String?  // O ID do produto no Tiny (para baixar estoque corretamente)
  sku             String?  // O Código único (Ex: VELA-NGK-123) - ESSENCIAL PARA O TINY


  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Pedido {
  id              Int      @id @default(autoincrement())
  clienteNome     String
  clienteEmail    String
  clienteEndereco String
  clienteTelefone String?
  clienteDoc      String?
  valorTotal      Float
  itens           String


  
  afiliadoId      Int?     
  afiliado        Afiliado? @relation(fields: [afiliadoId], references: [id])
  comissaoGerada  Float    @default(0.0)
  notificado_afiliado Boolean @default(false)
  status          String   @default("PENDENTE")

  asaasId         String?
  metodoPagamento String?   // Vai salvar "PIX", "CARTAO", "BOLETO", etc.

  // CAMPOS DE INTEGRAÇÃO TINY
  tinyId          String?  // O ID do pedido lá dentro do Tiny
  numeroNota      String?  // O número da NF quando for emitida
  linkNota        String?  // O link do PDF da nota para mostrar pro cliente
  statusTiny      String?  // Ex: "Aberto", "Faturado", "Enviado"

  createdAt       DateTime @default(now())
}

model Orcamento {
  id        Int      @id @default(autoincrement())
  nome      String   // Ex: "Orçamento Gol do João"
  itens     String   // Vamos salvar o JSON do carrinho aqui
  total     Float

  clienteDoc  String?
  
  afiliadoId Int
  afiliado   Afiliado @relation(fields: [afiliadoId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Mensagem {
  id        Int      @id @default(autoincrement())
  texto     String
  arquivo   String?
  lida      Boolean  @default(false)
  
  afiliadoId Int
  afiliado   Afiliado @relation(fields: [afiliadoId], references: [id])
  
  createdAt DateTime @default(now())
}

model Sugestao {
  id        Int      @id @default(autoincrement())
  termo     String   // O que ele digitou (ex: "Tripoide")
  motivo    String?  // Ex: "Conhecido também como..."
  status    String   @default("PENDENTE") // PENDENTE, APROVADO, REJEITADO
  
  produtoId Int
  produto   Produto  @relation(fields: [produtoId], references: [id])
  
  afiliadoId Int
  afiliado   Afiliado @relation(fields: [afiliadoId], references: [id])
  
  createdAt DateTime @default(now())
}


model Saque {
  id              Int      @id @default(autoincrement())
  valor           Float
  status          String   @default("PENDENTE") // PENDENTE ou PAGO
  dataSolicitacao DateTime @default(now())
  dataPagamento   DateTime?
  comprovante     String?

  afiliadoId      Int
  afiliado        Afiliado @relation(fields: [afiliadoId], references: [id])
}

model ClienteAfiliado {
  id          Int      @id @default(autoincrement())
  nome        String
  tipo        String   // "PF" ou "PJ"
  documento   String?  // CPF ou CNPJ
  telefone    String?
  email       String?
  endereco    String?
  
  afiliadoId  Int
  afiliado    Afiliado @relation(fields: [afiliadoId], references: [id])
  
  createdAt   DateTime @default(now())
}